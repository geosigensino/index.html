<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Painel de Mensagens - Eco Smart Group</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    :root{
      /* Paleta (base) */
      --green-strong:#1d4a0b;   /* principal */
      --green-hover:#2c5916;    /* hover */
      --green-soft:#577349;     /* apoio */
      --bg:#f2f2f2;             /* fundo claro */
      --text:#0b0b0b;           /* texto principal */
      --muted:#4b5563;          /* texto secundário */
      --border:#d1d5db;
      --card:#ffffff;
      --danger:#b91c1c;
      --danger-hover:#991b1b;

      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: var(--bg);
      color: var(--text);
    }

    body { margin: 0; padding: 0; background: var(--bg); }

    .app{
      max-width: 980px;
      margin: 0 auto;
      padding: 16px;
    }

    .card{
      background: var(--card);
      border-radius: 12px;
      padding: 16px 18px;
      box-shadow: 0 8px 20px rgba(15, 23, 42, 0.07);
      margin-bottom: 16px;
      border: 1px solid rgba(0,0,0,0.04);
    }

    h1,h2,h3{ margin: 0 0 12px 0; }
    h1{ font-size: 1.4rem; }
    h2{ font-size: 1.2rem; }
    h3{ font-size: 1rem; color: var(--muted); }

    label{
      display:block;
      font-size:.85rem;
      margin-bottom:4px;
      color: var(--muted);
    }

    input[type="text"],
    input[type="password"],
    select,
    textarea{
      width:100%;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid var(--border);
      font-size: .95rem;
      box-sizing: border-box;
      outline: none;
      background:#fff;
      color: var(--text);
    }

    textarea{ min-height: 90px; resize: vertical; }

    input:focus, select:focus, textarea:focus{
      border-color: var(--green-strong);
      box-shadow: 0 0 0 3px rgba(29, 74, 11, 0.15);
    }

    .btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding: 10px 16px;
      border-radius: 999px;
      border: none;
      font-size: .95rem;
      cursor: pointer;
      background: var(--green-strong);
      color: #fff;
      font-weight: 600;
      gap: 6px;
      transition: transform .05s ease, box-shadow .1s ease, background .15s ease;
      box-shadow: 0 10px 18px rgba(29, 74, 11, 0.18);
    }

    .btn:hover{
      background: var(--green-hover);
      box-shadow: 0 12px 22px rgba(29, 74, 11, 0.24);
      transform: translateY(-1px);
    }
    .btn:active{ transform: translateY(0); box-shadow: none; }

    .btn-outline{
      background:#fff;
      color: var(--green-strong);
      border:1px solid rgba(29, 74, 11, 0.25);
      box-shadow:none;
    }
    .btn-outline:hover{
      background: rgba(29, 74, 11, 0.06);
      transform: translateY(-1px);
    }

    .btn-danger{ background: var(--danger); box-shadow: 0 10px 18px rgba(185, 28, 28, 0.15); }
    .btn-danger:hover{ background: var(--danger-hover); }

    .btn-sm{
      padding: 7px 12px;
      font-size: .8rem;
      border-radius: 999px;
    }

    .stack{ display:flex; flex-direction:column; gap:10px; }
    .stack-row{ display:flex; flex-wrap:wrap; gap:10px; align-items:center; }

    .badge{
      display:inline-flex;
      align-items:center;
      padding: 3px 10px;
      border-radius: 999px;
      font-size: .75rem;
      background: #e5e7eb;
      color: #111827;
      border: 1px solid rgba(0,0,0,0.06);
      line-height: 1.2;
    }

    .badge-info{ background: rgba(87, 115, 73, 0.15); color: var(--green-strong); border-color: rgba(87,115,73,0.25); }
    .badge-success{ background: rgba(29, 74, 11, 0.12); color: var(--green-strong); border-color: rgba(29,74,11,0.25); }
    .badge-danger{ background: rgba(185, 28, 28, 0.12); color: var(--danger); border-color: rgba(185,28,28,0.2); }

    .table-wrap{
      width:100%;
      overflow-x:auto;
      -webkit-overflow-scrolling: touch;
    }

    .table{
      width:100%;
      border-collapse: collapse;
      font-size: .85rem;
      min-width: 760px; /* garante boa leitura e ativa scroll no mobile */
    }

    .table th, .table td{
      padding: 10px 10px;
      border-bottom: 1px solid #e5e7eb;
      text-align:left;
      vertical-align: top;
    }

    .table th{
      background: #fafafa;
      font-weight: 700;
      color: #374151;
      position: sticky;
      top: 0;
      z-index: 1;
    }

    .muted{ font-size:.85rem; color:#6b7280; }
    .tag{
      font-size:.8rem;
      padding: 3px 10px;
      border-radius: 999px;
      border:1px solid rgba(29, 74, 11, 0.18);
      color: var(--green-strong);
      background: rgba(29,74,11,0.06);
      font-weight: 600;
    }

    .header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap: 12px;
    }

    .header-title{ display:flex; flex-direction:column; gap: 3px; }

    .pill{
      font-size:.8rem;
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(29,74,11,0.08);
      color: var(--green-strong);
      display:inline-flex;
      align-items:center;
      gap: 6px;
      border: 1px solid rgba(29,74,11,0.18);
      font-weight: 600;
    }

    .divider{ height:1px; background:#e5e7eb; margin: 10px 0; }
    .message-title{ font-weight: 800; margin-bottom: 2px; }
    .message-text{ font-size: .9rem; color: var(--muted); white-space: pre-wrap; }

    .no-data{ font-size:.9rem; color:#9ca3af; padding: 6px 0; }

    /* Mobile */
    @media (max-width: 640px){
      .app{ padding: 10px; }
      .card{ padding: 14px; }
      .header{ flex-direction: column; align-items:flex-start; }
      .stack-row{ width: 100%; }
      .stack-row .btn-sm, .stack-row .btn, .btn-outline.btn-sm{
        width: 100%;
        justify-content:center;
      }
      .table{ min-width: 740px; } /* mantém scroll no mobile */
    }
  </style>
</head>

<body>
  <div class="app">
    <!-- LOGIN -->
    <div id="loginCard" class="card">
      <h1>Painel de Mensagens · Eco Smart Group</h1>
      <p class="muted">
        Selecione o perfil e informe a senha.
      </p>
      <div class="divider"></div>

      <div class="stack">
        <div>
          <label for="roleSelect">Entrar como</label>
          <select id="roleSelect">
            <option value="Administrador">Administrador</option>
            <option value="Bruno Ferreira">Bruno Ferreira</option>
            <option value="Carlos Barretto">Carlos Barretto</option>
            <option value="Bruno Santos">Bruno Santos</option>
          </select>
        </div>

        <div id="adminPasswordContainer">
          <label for="adminPassword">Senha do administrador</label>
          <input type="password" id="adminPassword" placeholder="Digite a senha do administrador" />
        </div>

        <div id="userPasswordContainer" style="display:none;">
          <label for="userPassword">Senha do sócio</label>
          <input type="password" id="userPassword" placeholder="Digite a senha do seu usuário" />
        </div>

        <button class="btn" id="btnLogin">Entrar</button>
      </div>
    </div>

    <!-- ÁREA PRINCIPAL -->
    <div id="mainArea" style="display:none;">
      <div class="card">
        <div class="header">
          <div class="header-title">
            <h1 id="viewTitle">Painel</h1>
            <span class="muted" id="viewSubtitle"></span>
            <span class="muted" id="ipInfo"></span>
          </div>
          <div class="stack-row">
            <span class="pill">Usuário ativo: <span id="currentUserLabel"></span></span>
            <button class="btn-outline btn-sm" id="btnLogout">Sair</button>
          </div>
        </div>
      </div>

      <!-- CRIAÇÃO -->
      <div id="creatorArea" class="card" style="display:none;">
        <h2>Criar nova mensagem</h2>
        <p class="muted">A mensagem será registrada e poderá ser confirmada pelos outros sócios (prazo: 24h).</p>
        <div class="stack">
          <div>
            <label for="msgTitulo">Título da mensagem</label>
            <input type="text" id="msgTitulo" placeholder="Ex.: Alinhamento de agenda da Eco Smart Group" />
          </div>
          <div>
            <label for="msgTexto">Texto / conteúdo</label>
            <textarea id="msgTexto" placeholder="Descreva o recado ou alinhamento aqui..."></textarea>
          </div>
          <button class="btn" id="btnSalvarMensagem">Salvar mensagem</button>
          <p id="creatorFeedback" class="muted"></p>
        </div>
      </div>

      <!-- VISÃO SÓCIOS -->
      <div id="sociosArea" style="display:none;">
        <div class="card">
          <h2>Minhas mensagens criadas</h2>
          <p class="muted">Editar ou excluir não apaga o histórico do administrador.</p>
          <div id="listaMinhasMensagens"></div>
        </div>

        <div class="card">
          <h2>Mensagens para eu confirmar</h2>
          <p class="muted">Confirmação válida por 24 horas a partir da criação.</p>
          <div id="listaParaConfirmar"></div>
        </div>
      </div>

      <!-- VISÃO ADMIN -->
      <div id="adminArea" style="display:none;">
        <div class="card">
          <h2>Resumo das mensagens</h2>
          <p class="muted">O administrador enxerga todas as mensagens, inclusive as excluídas pelos autores.</p>
          <div id="adminListaMensagens"></div>
        </div>

        <div class="card">
          <h2>Detalhes da mensagem selecionada</h2>
          <div id="adminDetalhesMensagem">
            <p class="no-data">Selecione uma mensagem na tabela acima para ver os detalhes e as confirmações.</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- JS -->
  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    // SUPABASE
    const supabaseUrl = "https://rnojyllnuowrzwogzrvs.supabase.co";
    const supabaseKey =
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJub2p5bGxudW93cnp3b2d6cnZzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU0MjE4NjYsImV4cCI6MjA4MDk5Nzg2Nn0.UlHgGG79W2t9-L4xsnZNtry5qAZ9-aOQN3Mmt3tCGHc";
    const supabase = createClient(supabaseUrl, supabaseKey);

    // CONFIG
    const USERS = ["Bruno Ferreira", "Carlos Barretto", "Bruno Santos"];
    const ADMIN_NAME = "Administrador";
    const ADMIN_PASSWORD = "ESG_2025";

    // Senhas dos sócios (troque aqui quando quiser)
    const USER_PASSWORDS = {
      "Bruno Ferreira": "BF_eco2025!",
      "Carlos Barretto": "CB_eco2025!",
      "Bruno Santos": "BS_eco2025!",
    };

    let currentIP = null;
    let currentUser = null;
    let currentRole = null; // "admin" | "user"
    let messages = [];

    // IP
    async function fetchIP() {
      const ipInfoEl = document.getElementById("ipInfo");
      ipInfoEl.textContent = "Buscando IP do dispositivo...";
      try {
        const res = await fetch("https://api.ipify.org?format=json");
        const data = await res.json();
        currentIP = data.ip;
        ipInfoEl.textContent = "IP detectado: " + currentIP;
      } catch (e) {
        console.error("Erro ao obter IP:", e);
        currentIP = null;
        ipInfoEl.textContent =
          "Não foi possível identificar o IP. A confirmação ficará bloqueada.";
      }
    }

    // UTIL
    function formatDateTime(dateString) {
      const d = new Date(dateString);
      if (isNaN(d)) return "";
      return d.toLocaleString("pt-BR");
    }

    function isExpired(createdAt) {
      const created = new Date(createdAt);
      if (isNaN(created)) return false;
      const now = new Date();
      return (now - created) > (24 * 60 * 60 * 1000);
    }

    function getRemainingTime(createdAt) {
      const created = new Date(createdAt);
      if (isNaN(created)) return null;
      const now = new Date();
      const limitMs = 24 * 60 * 60 * 1000;
      const diffMs = limitMs - (now - created);
      if (diffMs <= 0) return null;
      const totalMinutes = Math.floor(diffMs / (60 * 1000));
      const hours = Math.floor(totalMinutes / 60);
      const minutes = totalMinutes % 60;
      return { hours, minutes };
    }

    function formatRemainingText(createdAt) {
      const r = getRemainingTime(createdAt);
      if (!r) return null;
      const { hours, minutes } = r;
      if (hours <= 0 && minutes <= 0) return "Faltam menos de 1 minuto para expirar";
      if (hours > 0 && minutes > 0) return `Faltam ${hours}h ${minutes}min para expirar`;
      if (hours > 0 && minutes === 0) return `Faltam ${hours}h para expirar`;
      return `Faltam ${minutes}min para expirar`;
    }

    function copyToClipboard(text) {
      if (!navigator.clipboard) {
        alert("Copie o link manualmente:\n\n" + text);
        return;
      }
      navigator.clipboard.writeText(text).then(
        () => alert("Link copiado para a área de transferência."),
        () => alert("Não foi possível copiar automaticamente. Copie manualmente:\n\n" + text)
      );
    }

    // ELEMENTOS
    const loginCard = document.getElementById("loginCard");
    const mainArea = document.getElementById("mainArea");
    const roleSelect = document.getElementById("roleSelect");
    const adminPasswordContainer = document.getElementById("adminPasswordContainer");
    const userPasswordContainer = document.getElementById("userPasswordContainer");
    const adminPasswordInput = document.getElementById("adminPassword");
    const userPasswordInput = document.getElementById("userPassword");
    const btnLogin = document.getElementById("btnLogin");
    const btnLogout = document.getElementById("btnLogout");
    const currentUserLabel = document.getElementById("currentUserLabel");
    const viewTitle = document.getElementById("viewTitle");
    const viewSubtitle = document.getElementById("viewSubtitle");

    const creatorArea = document.getElementById("creatorArea");
    const sociosArea = document.getElementById("sociosArea");
    const adminArea = document.getElementById("adminArea");

    const msgTituloInput = document.getElementById("msgTitulo");
    const msgTextoInput = document.getElementById("msgTexto");
    const btnSalvarMensagem = document.getElementById("btnSalvarMensagem");
    const creatorFeedback = document.getElementById("creatorFeedback");

    const listaMinhasMensagens = document.getElementById("listaMinhasMensagens");
    const listaParaConfirmar = document.getElementById("listaParaConfirmar");

    const adminListaMensagens = document.getElementById("adminListaMensagens");
    const adminDetalhesMensagem = document.getElementById("adminDetalhesMensagem");

    // LOGIN UI
    function syncLoginUI() {
      const role = roleSelect.value;
      if (role === "Administrador") {
        adminPasswordContainer.style.display = "block";
        userPasswordContainer.style.display = "none";
      } else {
        adminPasswordContainer.style.display = "none";
        userPasswordContainer.style.display = "block";
      }
    }
    roleSelect.addEventListener("change", syncLoginUI);
    syncLoginUI();

    btnLogin.addEventListener("click", async () => {
      const roleValue = roleSelect.value;

      if (roleValue === "Administrador") {
        const pass = adminPasswordInput.value.trim();
        if (pass !== ADMIN_PASSWORD) {
          alert("Senha do administrador incorreta.");
          return;
        }
        currentUser = ADMIN_NAME;
        currentRole = "admin";
      } else {
        const pass = userPasswordInput.value.trim();
        const expected = USER_PASSWORDS[roleValue];
        if (!expected) {
          alert("Usuário sem senha configurada. Ajuste USER_PASSWORDS no código.");
          return;
        }
        if (pass !== expected) {
          alert("Senha do usuário incorreta.");
          return;
        }
        currentUser = roleValue;
        currentRole = "user";
      }

      adminPasswordInput.value = "";
      userPasswordInput.value = "";

      loginCard.style.display = "none";
      mainArea.style.display = "block";
      currentUserLabel.textContent = currentUser;

      if (currentRole === "admin") {
        viewTitle.textContent = "Área do Administrador";
        viewSubtitle.textContent = "Visão completa das mensagens, confirmações e tentativas.";
      } else {
        viewTitle.textContent = "Painel do Sócio";
        viewSubtitle.textContent = "Confirmação com IP e prazo de 24 horas (com contagem regressiva).";
      }

      await fetchIP();
      await refreshAndRender();
      startCountdownTicker(); // atualiza só a contagem, sem bater no Supabase
    });

    btnLogout.addEventListener("click", () => {
      currentUser = null;
      currentRole = null;
      stopCountdownTicker();
      loginCard.style.display = "block";
      mainArea.style.display = "none";
    });

    // SUPABASE LOAD
    async function loadMessagesFromSupabase() {
      const { data: msgs, error: errMsgs } = await supabase
        .from("messages")
        .select("*")
        .order("created_at", { ascending: false });

      if (errMsgs) {
        console.error("Erro ao carregar mensagens:", errMsgs);
        messages = [];
        return;
      }

      const { data: confs, error: errConfs } = await supabase
        .from("message_confirmations")
        .select("*");
      if (errConfs) console.error("Erro ao carregar confirmações:", errConfs);

      const { data: atts, error: errAtts } = await supabase
        .from("message_attempts")
        .select("*");
      if (errAtts) console.error("Erro ao carregar tentativas:", errAtts);

      const confsByMsg = {};
      (confs || []).forEach((row) => {
        (confsByMsg[row.message_id] ||= []).push(row);
      });

      const attsByMsg = {};
      (atts || []).forEach((row) => {
        (attsByMsg[row.message_id] ||= []).push(row);
      });

      messages = (msgs || []).map((m) => {
        const obj = {
          id: m.id,
          titulo: m.title,
          texto: m.body,
          autor: m.author_name,
          createdAt: m.created_at,
          deletedByAuthor: m.deleted_by_author,
          confirmations: {},
          attempts: [],
        };

        USERS.forEach((u) => {
          if (u !== obj.autor) obj.confirmations[u] = null;
        });

        (confsByMsg[m.id] || []).forEach((c) => {
          obj.confirmations[c.user_name] = { time: c.confirmed_at, ip: c.ip };
        });

        obj.attempts = (attsByMsg[m.id] || []).map((a) => ({
          user: a.attempted_by,
          ip: a.ip,
          time: a.attempted_at,
          reason: a.reason,
        }));

        return obj;
      });
    }

    async function refreshAndRender() {
      await loadMessagesFromSupabase();
      renderView();
    }

    // CRIAR MENSAGEM
    btnSalvarMensagem.addEventListener("click", async () => {
      const titulo = msgTituloInput.value.trim();
      const texto = msgTextoInput.value.trim();

      if (!titulo) return alert("Informe um título para a mensagem.");
      if (!texto) return alert("Informe o conteúdo da mensagem.");

      const { error } = await supabase.from("messages").insert({
        title: titulo,
        body: texto,
        author_name: currentUser,
      });

      if (error) {
        console.error("Erro ao salvar mensagem:", error);
        return alert("Erro ao salvar mensagem.");
      }

      msgTituloInput.value = "";
      msgTextoInput.value = "";
      creatorFeedback.textContent = "Mensagem criada e registrada com sucesso.";
      setTimeout(() => (creatorFeedback.textContent = ""), 2500);

      await refreshAndRender();
    });

    // VIEW
    function renderView() {
      creatorArea.style.display = currentUser ? "block" : "none";

      if (currentRole === "admin") {
        sociosArea.style.display = "none";
        adminArea.style.display = "block";
        renderAdminView();
      } else {
        sociosArea.style.display = "block";
        adminArea.style.display = "none";
        renderSociosView();
      }
    }

    // SÓCIOS
    function renderSociosView() {
      const minhas = messages.filter((m) => m.autor === currentUser && !m.deletedByAuthor);

      if (minhas.length === 0) {
        listaMinhasMensagens.innerHTML = '<p class="no-data">Você ainda não criou nenhuma mensagem.</p>';
      } else {
        let html = '<div class="table-wrap"><table class="table"><thead><tr>' +
          "<th>Título</th><th>Criada em</th><th>Confirmações</th><th>Ações</th>" +
          "</tr></thead><tbody>";

        minhas.forEach((m) => {
          const totalRecebedores = Object.keys(m.confirmations || {}).length;
          const totalConfirmadas = Object.values(m.confirmations || {}).filter((v) => v !== null).length;

          html += `<tr>
            <td>
              <div class="message-title">${m.titulo}</div>
              <div class="muted">Autor: ${m.autor}</div>
            </td>
            <td>${formatDateTime(m.createdAt)}</td>
            <td><span class="tag">${totalConfirmadas} / ${totalRecebedores}</span></td>
            <td>
              <div class="stack-row">
                <button class="btn-sm btn-outline" onclick="copyMessageLink('${m.id}')">Copiar link</button>
                <button class="btn-sm btn-outline" onclick="editarMensagem('${m.id}')">Editar</button>
                <button class="btn-sm btn-danger" onclick="excluirMensagem('${m.id}')">Excluir</button>
              </div>
            </td>
          </tr>`;
        });

        html += "</tbody></table></div>";
        listaMinhasMensagens.innerHTML = html;
      }

      const paraConfirmar = messages.filter((m) => {
        if (m.deletedByAuthor) return false;
        if (m.autor === currentUser) return false;
        if (!m.confirmations || !(currentUser in m.confirmations)) return false;
        return true;
      });

      if (paraConfirmar.length === 0) {
        listaParaConfirmar.innerHTML = '<p class="no-data">Não há mensagens pendentes para você confirmar.</p>';
      } else {
        let html = '<div class="table-wrap"><table class="table"><thead><tr>' +
          "<th>Título</th><th>Autor</th><th>Conteúdo</th><th>Status</th><th>Ação</th>" +
          "</tr></thead><tbody>";

        paraConfirmar.forEach((m) => {
          const status = m.confirmations[currentUser];
          const jaConfirmou = !!status;
          const expirado = isExpired(m.createdAt);
          const remainingText = (!jaConfirmou && !expirado) ? formatRemainingText(m.createdAt) : null;

          html += `<tr>
            <td>${m.titulo}</td>
            <td>${m.autor}</td>
            <td><div class="message-text">${m.texto}</div></td>
            <td>
              ${
                jaConfirmou
                  ? `<span class="badge badge-success">Confirmado em ${formatDateTime(status.time)}</span>`
                  : expirado
                    ? `<span class="badge badge-danger">Prazo expirado (24h)</span>`
                    : `<span class="badge badge-info">Pendente</span>`
              }
              ${
                remainingText
                  ? `<div class="muted countdown" data-created-at="${m.createdAt}" data-msg-id="${m.id}">${remainingText}</div>`
                  : ""
              }
            </td>
            <td>
              ${
                jaConfirmou
                  ? `<span class="muted">Nada a fazer</span>`
                  : expirado
                    ? `<span class="muted">Prazo encerrado</span>`
                    : `<button class="btn-sm" onclick="confirmarLeitura('${m.id}')">Confirmar leitura</button>`
              }
            </td>
          </tr>`;
        });

        html += "</tbody></table></div>";
        listaParaConfirmar.innerHTML = html;
      }
    }

    window.editarMensagem = async function (id) {
      const msg = messages.find((m) => m.id === id);
      if (!msg) return;
      if (msg.autor !== currentUser) return alert("Você só pode editar mensagens criadas por você.");

      const novoTitulo = prompt("Edite o título:", msg.titulo);
      if (novoTitulo === null) return;

      const novoTexto = prompt("Edite o texto:", msg.texto);
      if (novoTexto === null) return;

      const titulo = (novoTitulo.trim() || msg.titulo);
      const texto = (novoTexto.trim() || msg.texto);

      const { error } = await supabase
        .from("messages")
        .update({ title: titulo, body: texto })
        .eq("id", id)
        .eq("author_name", currentUser);

      if (error) {
        console.error("Erro ao editar mensagem:", error);
        return alert("Erro ao editar mensagem.");
      }

      await refreshAndRender();
    };

    window.excluirMensagem = async function (id) {
      const msg = messages.find((m) => m.id === id);
      if (!msg) return;
      if (msg.autor !== currentUser) return alert("Você só pode excluir mensagens criadas por você.");

      if (!confirm("Deseja excluir esta mensagem da sua visão? O administrador manterá o histórico.")) return;

      const { error } = await supabase
        .from("messages")
        .update({ deleted_by_author: true })
        .eq("id", id)
        .eq("author_name", currentUser);

      if (error) {
        console.error("Erro ao excluir mensagem:", error);
        return alert("Erro ao excluir mensagem.");
      }

      await refreshAndRender();
    };

    window.copyMessageLink = function (id) {
      const fakeUrl = window.location.origin + window.location.pathname + "?mensagem=" + id;
      copyToClipboard(fakeUrl);
    };

    window.confirmarLeitura = async function (id) {
      if (!currentIP) {
        return alert("Não foi possível identificar o IP do dispositivo. Recarregue a página e tente novamente.");
      }

      const msg = messages.find((m) => m.id === id);
      if (!msg) return alert("Mensagem não encontrada.");

      if (isExpired(msg.createdAt)) {
        return alert("O prazo de 24 horas para reconhecer esta mensagem já foi encerrado.");
      }

      const { data: confRows, error } = await supabase
        .from("message_confirmations")
        .select("*")
        .eq("message_id", id);

      if (error) {
        console.error("Erro ao buscar confirmações:", error);
        return alert("Erro ao verificar confirmações.");
      }

      const confs = confRows || [];

      const jaConfirmou = confs.find((c) => c.user_name === currentUser);
      if (jaConfirmou) return alert("Você já confirmou esta mensagem.");

      const outroComMesmoIP = confs.find((c) => c.ip === currentIP && c.user_name !== currentUser);
      if (outroComMesmoIP) {
        const reason = `IP já utilizado pelo usuário ${outroComMesmoIP.user_name} nesta mensagem`;
        const { error: attErr } = await supabase.from("message_attempts").insert({
          message_id: id,
          attempted_by: currentUser,
          ip: currentIP,
          reason,
        });
        if (attErr) console.error("Erro ao registrar tentativa:", attErr);

        await refreshAndRender();
        return alert("Este IP já foi utilizado para confirmar esta mensagem em outro usuário. Não é possível confirmar novamente.");
      }

      const { error: confErr } = await supabase.from("message_confirmations").insert({
        message_id: id,
        user_name: currentUser,
        ip: currentIP,
      });

      if (confErr) {
        console.error("Erro ao registrar confirmação:", confErr);
        return alert("Erro ao registrar confirmação.");
      }

      alert("Leitura confirmada com sucesso.");
      await refreshAndRender();
    };

    // ADMIN
    function renderAdminView() {
      if (messages.length === 0) {
        adminListaMensagens.innerHTML = '<p class="no-data">Não há mensagens registradas ainda.</p>';
        adminDetalhesMensagem.innerHTML = '<p class="no-data">Selecione uma mensagem para ver detalhes.</p>';
        return;
      }

      let html = '<div class="table-wrap"><table class="table"><thead><tr>' +
        "<th>Título</th><th>Autor</th><th>Data</th><th>Status</th><th>Confirmações</th><th>Ver</th>" +
        "</tr></thead><tbody>";

      messages.forEach((m) => {
        const totalRecebedores = Object.keys(m.confirmations || {}).length;
        const totalConfirmadas = Object.values(m.confirmations || {}).filter((v) => v !== null).length;
        const expirado = isExpired(m.createdAt);
        const remainingText = (!m.deletedByAuthor && !expirado) ? formatRemainingText(m.createdAt) : null;

        let statusBadge = '<span class="badge badge-info">Ativa</span>';
        if (m.deletedByAuthor) statusBadge = '<span class="badge badge-danger">Excluída pelo autor</span>';
        else if (expirado) statusBadge = '<span class="badge badge-danger">Prazo expirado (24h)</span>';

        html += `<tr>
          <td>${m.titulo}</td>
          <td>${m.autor}</td>
          <td>${formatDateTime(m.createdAt)}</td>
          <td>
            ${statusBadge}
            ${remainingText ? `<div class="muted countdown" data-created-at="${m.createdAt}" data-msg-id="${m.id}">${remainingText}</div>` : ""}
          </td>
          <td><span class="tag">${totalConfirmadas} / ${totalRecebedores}</span></td>
          <td><button class="btn-sm btn-outline" onclick="verDetalhesAdmin('${m.id}')">Detalhes</button></td>
        </tr>`;
      });

      html += "</tbody></table></div>";
      adminListaMensagens.innerHTML = html;
    }

    window.verDetalhesAdmin = function (id) {
      const msg = messages.find((m) => m.id === id);
      if (!msg) return;

      const expirado = isExpired(msg.createdAt);
      const remainingText = (!msg.deletedByAuthor && !expirado) ? formatRemainingText(msg.createdAt) : null;

      let statusTexto = "Ativa";
      if (msg.deletedByAuthor) statusTexto = "Excluída pelo autor (mantida para registro)";
      else if (expirado) statusTexto = "Prazo expirado (24h) para reconhecimento";

      let html = `<div class="stack">
        <div>
          <div class="message-title">${msg.titulo}</div>
          <div class="muted">Autor: ${msg.autor}</div>
          <div class="muted">Criada em: ${formatDateTime(msg.createdAt)}</div>
          <div class="muted">Status: ${statusTexto}</div>
          ${remainingText ? `<div class="muted countdown" data-created-at="${msg.createdAt}" data-msg-id="${msg.id}">${remainingText}</div>` : ""}
        </div>

        <div>
          <h3>Conteúdo</h3>
          <div class="message-text">${msg.texto}</div>
        </div>

        <div>
          <h3>Confirmações de leitura (por usuário e IP)</h3>`;

      const confs = msg.confirmations || {};
      html += `<div class="table-wrap"><table class="table"><thead><tr>
        <th>Sócio</th><th>Status</th><th>Data/hora</th><th>IP</th>
      </tr></thead><tbody>`;

      Object.keys(confs).forEach((user) => {
        const info = confs[user];
        html += `<tr>
          <td>${user}</td>
          <td>${info ? '<span class="badge badge-success">Confirmado</span>' : '<span class="badge badge-info">Pendente</span>'}</td>
          <td>${info ? formatDateTime(info.time) : "-"}</td>
          <td>${info ? info.ip : "-"}</td>
        </tr>`;
      });

      html += `</tbody></table></div></div>`;

      html += `<div>
        <h3>Tentativas de confirmação bloqueadas</h3>`;

      const attempts = Array.isArray(msg.attempts) ? msg.attempts : [];
      if (attempts.length === 0) {
        html += `<p class="no-data">Não foram registradas tentativas bloqueadas para esta mensagem.</p>`;
      } else {
        html += `<div class="table-wrap"><table class="table"><thead><tr>
          <th>Usuário que tentou</th><th>Data/hora</th><th>IP</th><th>Motivo</th>
        </tr></thead><tbody>`;
        attempts.forEach((att) => {
          html += `<tr>
            <td>${att.user}</td>
            <td>${formatDateTime(att.time)}</td>
            <td>${att.ip}</td>
            <td>${att.reason}</td>
          </tr>`;
        });
        html += `</tbody></table></div>`;
      }

      html += `</div></div>`;
      adminDetalhesMensagem.innerHTML = html;
    };

    // TICKER (atualiza somente os textos de contagem regressiva, sem recarregar do Supabase)
    let ticker = null;

    function updateCountdownTexts() {
      document.querySelectorAll(".countdown").forEach((el) => {
        const createdAt = el.getAttribute("data-created-at");
        const text = formatRemainingText(createdAt);
        if (!text) {
          el.textContent = "Prazo encerrado";
        } else {
          el.textContent = text;
        }
      });
    }

    function startCountdownTicker() {
      stopCountdownTicker();
      updateCountdownTexts();
      ticker = setInterval(updateCountdownTexts, 30 * 1000); // a cada 30s
    }

    function stopCountdownTicker() {
      if (ticker) clearInterval(ticker);
      ticker = null;
    }
  </script>
</body>
</html>
